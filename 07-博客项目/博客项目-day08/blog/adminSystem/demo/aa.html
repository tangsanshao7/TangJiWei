<h1 id="day93-博客项目后台管理系统">day93-博客项目(后台管理系统)</h1>
<h2 id="项目介绍">项目介绍</h2>
<h2 id="项目计划八天时间">项目计划(八天时间)</h2>
<p>前台(用户看到的) 2-3天时间  --网站   前后端分离的方式
后台(站长看到的) 4-5天时间  --网站   传统后端模板渲染的方式(过时)</p>
<h2 id="后台项目准备工作">后台项目准备工作</h2>
<h3 id="物料准备">物料准备</h3>
<p>1.页面
2.库(jquery art-template)
3.文件夹</p>
<h3 id="服务器搭建">服务器搭建</h3>
<p><code>app.js</code></p>
<pre><code class="language-js">// 1.导入包
// 1.1 导入express框架
const express = require(&#39;express&#39;);
// 1.2 导入path模块
const path = require(&#39;path&#39;);

// 2.设置包
// 2.1 使用express方法创建Web服务
const app = express();
// 2.2 设置静态资源目录
app.use(express.static(path.join(__dirname, &#39;public&#39;)));


// 3.处理请求



// 4.指定端口启动服务
app.listen(80, () =&gt; {
  console.log(&quot;服务器已启动,请打开 http://localhost&quot;);
})</code></pre>
<p><code>检测:</code> 网址是 <a href="http://localhost/">http://localhost/</a> 打开 能显示页面说明 服务器搭建 成功了</p>
<h2 id="数据库设计一般看的是原型">数据库设计(一般看的是原型)</h2>
<h3 id="用户表">用户表</h3>
<pre><code class="language-js">  let userSchema =new  mongoose.Schema({
    // 用户名(必填 长度在6-18位之间)
    username: String,
    // 密码(必填 长度再6-12位之间 包括字母和数字)
    password: String,
    // 邮箱(一般很重要 找回密码 一般通过邮箱  邮箱要保证唯一 必选)
    email: String,
    // 状态(1 true: 用户正常, 0 false: 用户被禁用)
    status: Boolean,
    // 角色(普通用户还是超级管理员 要求必选)
    role: String
  })</code></pre>
<p><code>代码</code></p>
<pre><code class="language-js">// 创建并应用约束
let User = new mongoose.model(&quot;User&quot;, new mongoose.Schema({
  // 用户名(必填 长度在6-18位之间)
  username: {
    type: String,
    required: true,
    // 唯一
    unique: true,
    minlength: 6,
    maxlength: 18
  },
  // 密码(必填 长度再6-12位之间 包括字母和数字)
  password: {
    type: String,
    required: true,
    minlength: 6,
    maxlength: 12
  },
  // 邮箱(一般很重要 找回密码 一般通过邮箱  邮箱要保证唯一 必选)
  email: {
    type: String,
    required: true,
    unique: true
  },
  // 状态(1 true: 用户正常, 0 false: 用户被禁用)
  status: {
    type: Boolean,
    default: true
  },
  // 角色(普通用户还是超级管理员 要求必选)
  role: {
    type: String,
    required: true
  }
}))
// 这是在初始化数据库数据，因为以后会用界面去添加 因此只用一次就可以了
User.create({
  // 用户名(必填 长度在6-18位之间)
  username: &quot;WanLum&quot;,

  // 密码(必填 长度再6-12位之间 包括字母和数字)
  password: &quot;123456&quot;,
  // 邮箱(一般很重要 找回密码 一般通过邮箱  邮箱要保证唯一 必选)
  email: &quot;wanlum@qq.com&quot;,
  // 状态(1 true: 用户正常, 0 false: 用户被禁用)

  // 角色(普通用户还是超级管理员 要求必选)
  role: &quot;超级管理员&quot;
})</code></pre>
<p><code>检测</code>: 数据库中要有数据</p>
<h3 id="文章表">文章表</h3>
<pre><code class="language-js">let articleSchema=new mongoose.Schema({
  // 标题
  title: {
    type: String,
    required: true,
    maxlength: 20,
    minlength: 1  
  },
  // 作者
  author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: &#39;username&#39;,
    required: true
  },
  // 发布时间
  publishDate: {
    type:Date,
    default: Date.now
  },
  // 封面图片
  cover: {
    type: String,
    default: null
  },
  // 内容
  content: {
    type: String
  }
})</code></pre>
<p><code>代码</code></p>
<pre><code class="language-js">let Article = new mongoose.model(&quot;Article&quot;, new mongoose.Schema({
  // 标题
  title: {
    type: String,
    required: true,
    maxlength: 20,
    minlength: 1
  },
  // 作者
  author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: &#39;username&#39;,
    required: true
  },
  // 发布时间
  publishDate: {
    type: Date,
    default: Date.now
  },
  // 封面图片
  cover: {
    type: String,
    dafault: null
  },
  // 内容
  content: {
    type: String,
    required: true
  }
}));

Article.create({
  // 标题
  title: &quot;我的小羊在睡觉&quot;,
  // 作者
  author: &quot;5ed8c02e1b519a2c2c662e77&quot;,
  // 内容
  content: &quot;山里有个庙,庙里有个老和尚,老和尚给小和尚讲了一故事: 山里的小羊  肖恩在睡觉 &quot;
})</code></pre>
<p><code>检测</code>: 数据库中要有数据</p>
<h3 id="评论表">评论表</h3>
<h2 id="路由设置">路由设置</h2>
<h3 id="后台管理系统登录-">后台管理系统登录 /</h3>
<h4 id="用户">用户</h4>
<h5 id="用户列表-user">用户列表 /user/</h5>
<h5 id="用户管理-useredit">用户管理 /user/edit</h5>
<h4 id="文章">文章</h4>
<h5 id="文章列表-article">文章列表 /article/</h5>
<h5 id="文章管理-articleedit">文章管理 /article/edit</h5>
<h2 id="模板设置">模板设置</h2>
<h3 id="appjs">app.js</h3>
<pre><code class="language-js">// 用的模板引擎是art-template
app.engine(&#39;art&#39;, require(&#39;express-art-template&#39;));
app.set(&#39;views&#39;, path.join(__dirname, &#39;views&#39;));
app.set(&#39;view engine&#39;, &#39;art&#39;);</code></pre>
<h3 id="模板优化">模板优化</h3>
<h4 id="提取公共部分">提取公共部分</h4>
<h5 id="header">header</h5>
<pre><code class="language-html">&lt;!-- 头部 --&gt;
&lt;div class=&quot;header&quot;&gt;
    &lt;!-- 网站标志 --&gt;
    &lt;div class=&quot;logo fl&quot;&gt;
        黑马程序员 &lt;i&gt;ITHEIMA&lt;/i&gt;
    &lt;/div&gt;
    &lt;!-- /网站标志 --&gt;
    &lt;!-- 用户信息 --&gt;
    &lt;div class=&quot;info&quot;&gt;
        &lt;div class=&quot;profile dropdown fr&quot;&gt;
            &lt;span class=&quot;btn dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;
                admin
                &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;
            &lt;/span&gt;
            &lt;ul class=&quot;dropdown-menu&quot;&gt;
                &lt;li&gt;&lt;a href=&quot;/user/edit&quot;&gt;个人资料&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href=&quot;#&quot;&gt;退出登录&lt;/a&gt;&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;!-- /用户信息 --&gt;
&lt;/div&gt;
&lt;!-- /头部 --&gt;</code></pre>
<h5 id="aside">aside</h5>
<pre><code class="language-html">&lt;!-- 侧边栏 --&gt;
&lt;div class=&quot;aside fl&quot;&gt;
    &lt;ul class=&quot;menu list-unstyled&quot;&gt;
        &lt;li&gt;
            &lt;a class=&quot;item active&quot; href=&quot;/user&quot;&gt;
                &lt;span class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/span&gt;
                用户管理
            &lt;/a&gt;
        &lt;/li&gt;
        &lt;li&gt;
            &lt;a class=&quot;item&quot; href=&quot;/article&quot;&gt;
                &lt;span class=&quot;glyphicon glyphicon-th-list&quot;&gt;&lt;/span&gt;
                文章管理
            &lt;/a&gt;
        &lt;/li&gt;
    &lt;/ul&gt;
    &lt;div class=&quot;cprt&quot;&gt;
        Powered by &lt;a href=&quot;http://www.itheima.com/&quot; target=&quot;_blank&quot;&gt;黑马程序员&lt;/a&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
<h4 id="提取模板">提取模板</h4>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot;
    content=&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;&gt;
  &lt;title&gt;Blog - Content Manager&lt;/title&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;/lib/bootstrap-3.3.7/css/bootstrap.min.css&quot;&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;/css/base.css&quot;&gt;
  &lt;!-- 不同的页面 css文件是不一样 如果是不同的CSS文件 我应该变成一个坑 等未来想要什么样的css文件 把这个坑填上就可以了 --&gt;
  {{block &#39;link&#39;}}{{/block}}
&lt;/head&gt;

&lt;body&gt;
  &lt;!-- 因为主体内容不一样 因此也要留下一个空位(坑) --&gt;
  {{block &#39;main&#39;}}{{/block}}
  &lt;script src=&quot;/lib/jquery/jquery-3.5.1.js&quot;&gt;&lt;/script&gt;
  &lt;script src=&quot;/lib/bootstrap-3.3.7/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
  &lt;!-- 不同的页面 需要不同的js文件 引入 因此也要留下一个空位 --&gt;
  {{block &#39;script&#39;}}{{/block}}
&lt;/body&gt;

&lt;/html&gt;</code></pre>
<h5 id="使用模板">使用模板</h5>
<pre><code class="language-html">{{extend &#39;./common/layout.html&#39;}}



{{block &#39;main&#39;}}
{{include &#39;./common/header.html&#39;}}
&lt;!-- 主体内容 --&gt;
&lt;div class=&quot;content&quot;&gt;
    &lt;!-- 侧边栏 --&gt;
    {{include &#39;./common/aside.html&#39;}}
    &lt;!-- 侧边栏 --&gt;
    &lt;div class=&quot;main&quot;&gt;
        &lt;!-- 分类标题 --&gt;
        &lt;div class=&quot;title&quot;&gt;
            &lt;h4&gt;用户&lt;/h4&gt;
            &lt;span&gt;找到1个用户&lt;/span&gt;
            &lt;a href=&quot;user-edit.html&quot; class=&quot;btn btn-primary new&quot;&gt;新增用户&lt;/a&gt;
        &lt;/div&gt;
        &lt;!-- /分类标题 --&gt;
        &lt;!-- 内容列表 --&gt;
        &lt;table class=&quot;table table-striped table-bordered table-hover custom-table&quot;&gt;
            &lt;thead&gt;
                &lt;tr&gt;
                    &lt;th&gt;ID&lt;/th&gt;
                    &lt;th&gt;用户名&lt;/th&gt;
                    &lt;th&gt;邮箱&lt;/th&gt;
                    &lt;th&gt;角色&lt;/th&gt;
                    &lt;th&gt;状态&lt;/th&gt;
                    &lt;th&gt;操作&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
                &lt;tr&gt;
                    &lt;td&gt;5b9a716cb2d2bf17706bcc0a&lt;/td&gt;
                    &lt;td&gt;wangjian&lt;/td&gt;
                    &lt;td&gt;wjb19891223@163.com&lt;/td&gt;
                    &lt;td&gt;超级管理员&lt;/td&gt;
                    &lt;td&gt;正常&lt;/td&gt;
                    &lt;td&gt;
                        &lt;a href=&quot;user-edit.html&quot; class=&quot;glyphicon glyphicon-edit&quot;&gt;&lt;/a&gt;
                        &lt;i class=&quot;glyphicon glyphicon-remove&quot; data-toggle=&quot;modal&quot; data-target=&quot;.confirm-modal&quot;&gt;&lt;/i&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;5b9a716cb2d2bf17706bcc0a&lt;/td&gt;
                    &lt;td&gt;wangjian&lt;/td&gt;
                    &lt;td&gt;wjb19891223@163.com&lt;/td&gt;
                    &lt;td&gt;普通用户&lt;/td&gt;
                    &lt;td&gt;禁用&lt;/td&gt;
                    &lt;td&gt;
                        &lt;a href=&quot;user-edit.html&quot; class=&quot;glyphicon glyphicon-edit&quot;&gt;&lt;/a&gt;
                        &lt;i class=&quot;glyphicon glyphicon-remove&quot; data-toggle=&quot;modal&quot; data-target=&quot;.confirm-modal&quot;&gt;&lt;/i&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;5b9a716cb2d2bf17706bcc0a&lt;/td&gt;
                    &lt;td&gt;wangjian&lt;/td&gt;
                    &lt;td&gt;wjb19891223@163.com&lt;/td&gt;
                    &lt;td&gt;普通用户&lt;/td&gt;
                    &lt;td&gt;启用&lt;/td&gt;
                    &lt;td&gt;
                        &lt;a href=&quot;user-edit.html&quot; class=&quot;glyphicon glyphicon-edit&quot;&gt;&lt;/a&gt;
                        &lt;i class=&quot;glyphicon glyphicon-remove&quot; data-toggle=&quot;modal&quot; data-target=&quot;.confirm-modal&quot;&gt;&lt;/i&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
            &lt;/tbody&gt;
        &lt;/table&gt;
        &lt;!-- /内容列表 --&gt;
        &lt;!-- 分页 --&gt;
        &lt;ul class=&quot;pagination&quot;&gt;
            &lt;li&gt;
                &lt;a href=&quot;#&quot;&gt;
                    &lt;span&gt;&amp;laquo;&lt;/span&gt;
                &lt;/a&gt;
            &lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;1&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;2&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;3&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;4&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;5&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;
                &lt;a href=&quot;#&quot;&gt;
                    &lt;span&gt;&amp;raquo;&lt;/span&gt;
                &lt;/a&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
        &lt;!-- /分页 --&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;!-- /主体内容 --&gt;
&lt;!-- 删除确认弹出框 --&gt;
&lt;div class=&quot;modal fade confirm-modal&quot;&gt;
    &lt;div class=&quot;modal-dialog modal-lg&quot;&gt;
        &lt;form class=&quot;modal-content&quot;&gt;
            &lt;div class=&quot;modal-header&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot;&gt;&lt;span&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
                &lt;h4 class=&quot;modal-title&quot;&gt;请确认&lt;/h4&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-body&quot;&gt;
                &lt;p&gt;您确定要删除这个用户吗?&lt;/p&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-footer&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; data-dismiss=&quot;modal&quot;&gt;取消&lt;/button&gt;
                &lt;input type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;!-- /删除确认弹出框 --&gt;
{{/block}}

{{block &#39;script&#39;}}
&lt;script src=&quot;/js/user.js&quot;&gt;&lt;/script&gt;
{{/block}}</code></pre>
<h2 id="用户功能">用户功能</h2>
<h3 id="功能一-用户登录">功能一: 用户登录</h3>
<h4 id="思路">思路</h4>
<p>1.点击登录按钮 是否填写了邮箱和密码 如果其中某一项或两项没有填写 校验||提示 阻止提交
2.如果填写了，校验通过了，正常发起请求 post请求
3.设置路由
4.处理请求
4.1 比对(1.用邮箱去查询数据库中的数据 没有查到 说明邮箱或密码错误 2.查到了,数据库返回的信息中有密码 看看密码对不 如果不对 返回邮箱或密码错误)
5.跳转
6.密码(只能让自己知道 在提交过程中 你肯定不想让在你旁边的人知道 你还不想让管理员知道)
7.在node中实现登录状态保持 用的第三方插件 express-session 可以帮我们创建session 并且把sessionid保存到cookie中去</p>
<h4 id="步骤1-用户登录表单校验及请求发起">步骤1: 用户登录表单校验及请求发起</h4>
<pre><code class="language-js">// 实际上不需要表单插件来进行表单校验
// 1.表单校验插件好用
// 2.阻止默认提交
// 3.前端校验主要的作用是为了提高用户体验(提示用户)
$(function () {
  $(&quot;#login-form&quot;).validate({
    rules: {
      email: {
        required: true,
        email: true
      },
      password: {
        required: true,
      }

    },
    messages: {
      password: {
        required: &quot;密码必须填写&quot;,
      },
      email: {
        required: &quot;邮箱必须填写&quot;,
        email: &quot;邮箱格式错误&quot;
      }
    },
    // 提交处理
    submitHandler: function (form) {
      // console.log(form);
      let formdata = $(form).serialize();
      // console.log(formdata);

      $.ajax({
        type: &#39;POST&#39;,
        url: &#39;/api/login&#39;,
        data: formdata,
        // 成功时的回调
        success: function (result) {
          // console.log(result);
          if (result.code == 200) {
            location.href = &quot;/user&quot;
          }
        },
        // 失败时的回调
        error: function (err) {
          console.log(err);
          // console.log(err.responseJSON);
          if (JSON.parse(err.responseText).code == 400) {
            alert(JSON.parse(err.responseText).msg)
            $(form).find(&#39;input&#39;).val(&#39;&#39;);
          }
        }
      })
    }
  });
})</code></pre>
<h4 id="步骤2：处理登录业务后台校验比对">步骤2：处理登录业务(后台校验&amp;&amp;比对)</h4>
<pre><code class="language-js">// 用户登录
module.exports.login = async (req, res) =&gt; {
  // 获取邮箱和密码
  // console.log(req.body);
  // let email = req.body.email;
  // let password = req.body.password;
  // console.log(email, password);
  // let { email, password } = {
  //   email: &#39;232323@qq.com&#39;,
  //   password: &#39;235r42343&#39;
  // }

  // console.log(email, password)

  let { email, password } = req.body;
  // console.log(email, password);

  // 做后端校验
  if (email.trim().length == 0 || password.trim().length == 0) {
    return res.status(400).send({
      code: 400,
      msg: &quot;邮箱或密码错误&quot;
    })
  }
  // 去数据库中查询数据
  // 通过email查询用户的所有信息
  let user = await User.findOne({ email: email })
  // console.log(user);
  // 如果没有user 返回 null 如果有user 结果是对象
  if (user) {
    // 如果有这个用户 说明用户的email首先是对的，至于密码是否一样 不清楚 再次进行比对
    let isValid = (password === user.password);
    // console.log(isValid);
    if (isValid) {
      // email和密码完全正确res.status(200).send()
      // 用户名和密码存到session
      req.session.username = user.username;
      req.session.email = user.email;

      res.status(200).send({
        code: 200,
        message: &quot;登录成功&quot;
      })
    } else {
      return res.status(400).send({ code: 400, msg: &quot;邮箱或密码错误&quot; })
    }
  } else {
    return res.status(400).send({ code: 400, msg: &quot;邮箱或密码错误&quot; })
  }
}</code></pre>
<h4 id="步骤3：登录状态的保持（express-session）">步骤3：登录状态的保持（express-session）</h4>
<p><code>app.js</code></p>
<pre><code class="language-js">// 1.6 引入express-sesssion
const session = require(&#39;express-session&#39;);
// cookie的声明周期 如果不设置cookie的生命周期 他的周期就是浏览器打开出现 浏览器结束消失
app.use(session({
  // keyboard cat就是一个普通字符串
  // 密钥 secret 在这里表示的是签名(必须的)
  secret: &#39;keyboard cat&#39;,
  // resave: false,
  // 强制将未初始化的session保存
  // saveUninitialized: true,
  // maxAge就是cookie在浏览器中存在的时间，单位是毫秒
  cookie: { maxAge: 60000 }

}))</code></pre>
<p><code>indexCtrl.js</code></p>
<pre><code class="language-js"> // email和密码完全正确res.status(200).send()
      // 用户名和密码存到session
      req.session.username = user.username;
      req.session.email = user.email;</code></pre>
<h4 id="路由拦截">路由拦截</h4>
<pre><code class="language-js">// 判断一下 req.session.username
  if (!req.session.username) {
    // 如果没有 那么跳转到登录页面
    res.render(&#39;login&#39;);
  } else {
    // 如果有 那么跳转到用户列表页面 当我们访问路由 localhost:3000/的时候 我想让页面跳到别的页面 这叫重定向 redirect(地址)
    res.redirect(&#39;/user&#39;);
  }</code></pre>
<h3 id="功能二-用户退出登录">功能二: 用户退出登录</h3>
<h4 id="思路-1">思路</h4>
<p>1.在除了login这个页面的其他页面引入common.js
2.当点击退出登录按钮的是 发起ajax请求
3.使用epxress-session中的 Session.destroy(callback)来把cookie给破坏调
4.让用户的页面跳转到用户登录页面</p>
<h4 id="在commonjs中发起请求">在common.js中发起请求</h4>
<pre><code class="language-js">$(function () {
  // 点击退出按钮，退出登录
  $(&#39;.logout&#39;).on(&#39;click&#39;, &#39;a&#39;, function () {
    logout();
  })
})

// 用户退出
function logout() {
  $.ajax({
    type: &#39;GET&#39;,
    url: &#39;/api/logout&#39;,
    data: null,
    success: function (data) {
      // console.log(data);
      if (data.code == 200) {
        location.href = &#39;/&#39;
      }
    }
  })
}</code></pre>
<h4 id="在indexctrl中处理请求">在indexCtrl中处理请求</h4>
<pre><code class="language-js">// 用户退出
module.exports.logout = (req, res) =&gt; {
  req.session.destroy(function (err) {
    // cannot access session here 这里访问不到session
    // 清除cookie
    res.clearCookie(&#39;connect.sid&#39;);
    res.status(200).send({
      code: 200,
      msg: &quot;用户退出成功&quot;
    })
  })
  //  Cannot set headers after they are sent to the client 如果你写了多次send就有这个问题

}</code></pre>
<h4 id="退出简单方法用a标签的get请求替换ajax">退出简单方法(用a标签的GET请求替换ajax)</h4>
<p><code>header.html</code></p>
<pre><code class="language-html">&lt;li class=&quot;logout&quot;&gt;&lt;a href=&quot;/api/logout&quot;&gt;退出登录&lt;/a&gt;&lt;/li&gt;</code></pre>
<h3 id="功能三-分页查询用户">功能三: 分页查询用户</h3>
<h4 id="思路-2">思路</h4>
<p>  1.user.html中引入user.js 在user.js中写js代码
  2.在user.js中当 页面加载完毕 发起ajax请求
  3.设置路由
  4.处理请求获取正确结果
  5.渲染正确结果</p>
<h3 id="功能四-删除用户逻辑删除">功能四: 删除用户(逻辑删除)</h3>
<h4 id="思路-3">思路:</h4>
<p> 1.点击用户列表中的删除按钮 弹出删除对话框
 2.当点击删除按钮的时候 弹出对话框的同时 把用户id放在html的标签中
 3.当用户点击提交 把html标签中存的用户id给发送给后台服务器
 4.去数据库中根据id 更新用户数据 status 为false(意味着用户不可用)
 5.刷新页面</p>
<h4 id="步骤">步骤:</h4>
<p><code>user.js</code></p>
<pre><code class="language-js"> // 点击删除按钮 显示模态框
  $(&#39;tbody&#39;).on(&#39;click&#39;, &#39;i&#39;, function () {
    $(&#39;html&#39;).attr(&#39;data-id&#39;, $(this).data(&#39;id&#39;))
    $(&#39;.confirm-modal&#39;).modal(&#39;show&#39;)
  })
  // 点击删除按钮 删除用户
  $(&#39;.delete-user&#39;).click(function () {
    let userId = $(&#39;html&#39;).data(&#39;id&#39;);
    $.ajax({
      type: &#39;GET&#39;,
      url: &#39;/user/deleteUser&#39;,
      data: {
        id: userId
      },
      success: function (result) {
        // console.log(result);
        if (result.code == 200) {
          let pagenum = $(&#39;html&#39;).data(&#39;page&#39;);
          // console.log(pagenum);
          // 把页码传给服务器
          $(&#39;.confirm-modal&#39;).modal(&#39;hide&#39;)
          getUsers(pagenum);
        }
      }
    })
  })</code></pre>
<p><code>userROuter.js</code></p>
<pre><code class="language-js">// 3.3 删除用户
userRouter.get(&#39;/deleteUser&#39;, deleteUser)</code></pre>
<p><code>userCtrl.js</code></p>
<pre><code class="language-js">// 删除用户
module.exports.deleteUser = async (req, res) =&gt; {
  let { id } = req.query;
  let result = await User.findOneAndUpdate({
    _id: id
  }, {
    status: false
  })

  // console.log(result);
  res.status(200).send({
    code: 200,
    msg: &quot;用户删除成功&quot;,
    data: result.username
  })
}
</code></pre>
<h3 id="功能五-添加用户">功能五: 添加用户</h3>
<h4 id="思路-4">思路</h4>
<p>1.给新增用户按钮添加路由连接
2.修改添加用户页面 去除用户id
3.点击提交按钮 做表单校验
4.提交用户信息到服务器
5.在后端进行表单校验
6.校验用户输入的邮箱是否已经被使用
7.把密码进行加密
8.把用户信息添加到服务器去(更改以前写的代码)</p>
<h4 id="user-addhtml">user-add.html</h4>
<pre><code class="language-html">{{extend &#39;./common/layout.html&#39;}}

{{block &#39;main&#39;}}
{{include &#39;./common/header.html&#39;}}
&lt;!-- 主体内容 --&gt;
&lt;div class=&quot;content&quot;&gt;
    &lt;!-- 侧边栏 --&gt;
    {{include &#39;./common/aside.html&#39;}}
    &lt;!-- 侧边栏 --&gt;
    &lt;div class=&quot;main&quot;&gt;
        &lt;!-- 分类标题 --&gt;
        &lt;div class=&quot;title&quot;&gt;
            &lt;p class=&quot;tips&quot;&gt;错误信息&lt;/p&gt;
        &lt;/div&gt;
        &lt;!-- /分类标题 --&gt;
        &lt;form class=&quot;form-container&quot; id=&quot;add-form&quot;&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;用户名&lt;/label&gt;
                &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;username&quot; placeholder=&quot;请输入用户名&quot;&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;邮箱&lt;/label&gt;
                &lt;input type=&quot;email&quot; class=&quot;form-control&quot; name=&quot;email&quot; placeholder=&quot;请输入邮箱地址&quot;&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;密码&lt;/label&gt;
                &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot; placeholder=&quot;请输入密码&quot;&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;角色&lt;/label&gt;
                &lt;select class=&quot;form-control&quot; name=&quot;role&quot;&gt;
                    &lt;option value=&quot;普通用户&quot;&gt;普通用户&lt;/option&gt;
                    &lt;option value=&quot;超级管理员&quot;&gt;超级管理员&lt;/option&gt;
                &lt;/select&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;状态&lt;/label&gt;
                &lt;select class=&quot;form-control&quot; name=&quot;status&quot;&gt;
                    &lt;option value=&quot;1&quot;&gt;启用&lt;/option&gt;
                    &lt;option value=&quot;0&quot;&gt;禁用&lt;/option&gt;
                &lt;/select&gt;
            &lt;/div&gt;
            &lt;div class=&quot;buttons&quot;&gt;
                &lt;input type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;!-- /主体内容 --&gt;
{{/block}}

{{block &#39;script&#39;}}
&lt;script src=&quot;/lib/jquery-validation-1.15.0/jquery.validate.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/js/userAdd.js&quot;&gt;&lt;/script&gt;
{{/block}}</code></pre>
<h4 id="useraddjs">userAdd.js</h4>
<pre><code class="language-js">// 实际上不需要表单插件来进行表单校验
// 1.表单校验插件好用
// 2.阻止默认提交
// 3.前端校验主要的作用是为了提高用户体验(提示用户)
$(function () {
  $(&quot;#add-form&quot;).validate({
    rules: {
      username: {
        required: true,
        minlength: 6,
        maxlength: 18
      },
      password: {
        required: true,
        minlength: 6,
        maxlength: 12
      },
      email: {
        required: true,
        email: true
      },
      role: {
        required: true
      }
    },
    messages: {
      username: {
        required: &quot;用户名必须填写&quot;,
        minlength: &quot;用户名在6-18位之间&quot;,
        maxlength: &quot;用户名在6-18位之间&quot;
      },
      password: {
        required: &quot;密码必须填写&quot;,
        minlength: &quot;用户名在6-12位之间&quot;,
        maxlength: &quot;用户名在6-12位之间&quot;
      },
      email: {
        required: &quot;邮箱必须填写&quot;,
        email: &quot;邮箱格式不正确&quot;
      },
      role: {
        required: &quot;角色必须选择&quot;
      }

    },
    // 提交处理
    submitHandler: function (form) {
      let formData = $(form).serialize();
      // console.log(data);
      $.ajax({
        type: &#39;POST&#39;,
        url: &#39;/user/addUser&#39;,
        data: formData,
        // 发送请求成功 接受到了响应
        success: function (result) {
          // console.log(result);
          if (result.code == 400) {
            $(&#39;.title .tips&#39;).html(result.msg).addClass(&#39;error&#39;);
          }

          if (result.code == 200) {
            location.href = &#39;/user&#39;
          }
        }
      })
    }
  });
})</code></pre>
<h4 id="userrouterjs">userRouter.js</h4>
<pre><code class="language-js">userRouter.get(&#39;/add&#39;, addPage);
// 3.5 添加用户功能
userRouter.post(&#39;/addUser&#39;, addUser)</code></pre>
<h4 id="userctrljs">userCtrl.js</h4>
<pre><code class="language-js">// 添加用户
module.exports.addUser = async (req, res) =&gt; {
  // console.log(req.body);
  // 前端校验是为了提高用户体验 后端校验是为了业务 前端校验做不做都可以 但是后端必须做校验
  // 1.数据校验通过
  // 定义验证规则
  const schema = {
    // username必须是字符串类型、最小长度是2、最大长度是6、必填项、自定义验证失败错误信息
    username: Joi.string().min(6).max(18).required().error(new Error(&#39;用户名验证失败&#39;)),
    // password必须是字符串类型、必须符合指定的正则规则、自定义验证失败错误信息
    password: Joi.string().min(6).max(12).regex(/^[a-zA-Z0-9]+$/).error(new Error(&#39;密码验证失败&#39;)),
    // email必须是字符串类型、必须符合邮箱格式、必填项、自定义验证失败错误信息
    email: Joi.string().email().required().error(new Error(&#39;邮箱验证失败&#39;)),
    // 角色
    role: Joi.string().valid(&quot;普通用户&quot;, &quot;超级管理员&quot;).required().error(new Error(&#39;角色信息验证失败&#39;)),
    // 用户状态
    status: Joi.number().valid(1, 0).required().error(new Error(&#39;用户状态验证失败&#39;))
  }
  // 后端校验
  try {
    await Joi.validate(req.body, schema);
  } catch (error) {
    // status(200) 必须是200 因为如果不写200 浏览器会报错
    return res.send({
      // 写400方便我用js做判断
      code: 400,
      msg: error.message
    })
  }

  // console.log(&quot;我不应该被答应&quot;)
  // 用户名和邮箱在系统中 都是唯一的标识,如果用户注册的时候 用了别人的用户名或邮箱都是错误的
  let emailResult = await User.findOne({ email: req.body.email });
  let usernameResult = await User.findOne({ username: req.body.username });
  // console.log(emailResult);
  if (emailResult) {
    return res.send({
      // 写400方便我用js做判断
      code: 400,
      msg: &quot;邮箱已经被占用&quot;
    })
  }
  if (usernameResult) {
    return res.send({
      // 写400方便我用js做判断
      code: 400,
      msg: &quot;用户名已经被占用&quot;
    })
  }


  let newUser = {
    username: req.body.username,
    password: md5(md5(md5(req.body.password))),
    email: req.body.email,
    role: req.body.role,
    status: Boolean(req.body.status)
  }
  // console.log(newUser)
  let successResult = await User.create(newUser);
  // console.log(successResult);
  if (successResult.username) {
    res.send({
      // 写400方便我用js做判断
      code: 200,
      msg: &quot;用户注册成功&quot;
    })
  }

}</code></pre>
<h3 id="功能六-更新用户信息">功能六: 更新用户信息</h3>
<h4 id="思路-5">思路</h4>
<p>1.回显信息(弹模态框修改信息)
1.1 在用户列表页面的列表中 修改a标签 让它变成按钮
1.2 在用户列表页面准备一个模态框，把模态框做成模板
1.3 当点击a标签这个修改按钮的时候，发起ajax请求 获取用户数据
1.4 渲染模态框(用户信息写进去)并且把模态框显示出来
2.修改信息
2.1 点击保存按钮 获取所有信息
2.2 发起ajax请求
2.3 把数据发送给服务器
2.4 更新数据</p>
<h4 id="userhtml">user.html</h4>
<pre><code class="language-html">
&lt;!-- 用户信息修改弹出框 --&gt;
&lt;!-- Modal --&gt;
&lt;div class=&quot;modal fade&quot; id=&quot;modify-modal&quot; tabindex=&quot;-1&quot; aria-labelledby=&quot;myModalLabel&quot;&gt;
    &lt;!-- &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
            &lt;div class=&quot;modal-header&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span
                        aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
                &lt;h4 class=&quot;modal-title&quot; id=&quot;myModalLabel&quot;&gt;用户信息修改&lt;/h4&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-body&quot;&gt;
                ...
            &lt;/div&gt;
            &lt;div class=&quot;modal-footer&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; data-dismiss=&quot;modal&quot;&gt;取消&lt;/button&gt;
                &lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot;&gt;保存&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt; --&gt;
&lt;/div&gt;
&lt;!-- /用户信息你修改弹出框 --&gt;
&lt;!-- 用户信息模板 --&gt;
&lt;script type=&quot;text/template&quot; id=&quot;modify_templ&quot;&gt;
    &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
            &lt;div class=&quot;modal-header&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span
                        aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
                &lt;h4 class=&quot;modal-title&quot; id=&quot;myModalLabel&quot;&gt;用户信息修改&lt;/h4&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-body&quot;&gt;
                &lt;form  id=&quot;modify-form&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label&gt;用户名&lt;/label&gt;
                        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;username&quot; placeholder=&quot;请输入用户名&quot; value=&quot;{&amp; username &amp;}&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label&gt;邮箱&lt;/label&gt;
                        &lt;input type=&quot;email&quot; class=&quot;form-control&quot; name=&quot;email&quot; placeholder=&quot;请输入邮箱地址&quot; value=&quot;{&amp; email &amp;}&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label&gt;密码&lt;/label&gt;
                        &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot; placeholder=&quot;请输入密码&quot; value=&quot;{&amp; password &amp;}&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label&gt;角色&lt;/label&gt;
                        &lt;select class=&quot;form-control&quot; name=&quot;role&quot;&gt;
                            {&amp; if role ==&#39;普通用户&#39; &amp;}
                            &lt;option value=&quot;普通用户&quot; selected&gt;普通用户&lt;/option&gt;
                            &lt;option value=&quot;超级管理员&quot;&gt;超级管理员&lt;/option&gt;
                            {&amp; else &amp;}
                            &lt;option value=&quot;普通用户&quot; &gt;普通用户&lt;/option&gt;
                            &lt;option value=&quot;超级管理员&quot; selected&gt;超级管理员&lt;/option&gt;
                            {&amp; /if &amp;}
                        &lt;/select&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label&gt;状态&lt;/label&gt;
                        &lt;select class=&quot;form-control&quot; name=&quot;status&quot;&gt;
                            {&amp; if status &amp;}
                            &lt;option value=&quot;1&quot; selected&gt;启用&lt;/option&gt;
                            &lt;option value=&quot;0&quot;&gt;禁用&lt;/option&gt;
                            {&amp; else &amp;}
                            &lt;option value=&quot;1&quot;&gt;启用&lt;/option&gt;
                            &lt;option value=&quot;0&quot; selected&gt;禁用&lt;/option&gt;
                            {&amp; /if &amp;}
                        &lt;/select&gt;
                    &lt;/div&gt;

                    &lt;!-- &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;{&amp; _id &amp;}&quot;&gt; --&gt;
                &lt;/form&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-footer&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; data-dismiss=&quot;modal&quot;&gt;取消&lt;/button&gt;
                &lt;button type=&quot;button&quot; class=&quot;btn btn-primary save-btn&quot; data-id=&quot;{&amp; _id &amp;}&quot;&gt;保存&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/script&gt;</code></pre>
<h4 id="userjs">user.js</h4>
<pre><code class="language-js">  // 点击修改按钮 修改用户信息
  // 1)回显信息
  $(&#39;tbody&#39;).on(&#39;click&#39;, &#39;td a&#39;, function () {
    // let modifyStr = template(&#39;modify_templ&#39;, {});
    // $(&#39;#modify-modal&#39;).html(modifyStr);
    // $(&#39;#modify-modal&#39;).modal(&#39;show&#39;);

    // 获取用户id
    let userId = $(this).data(&#39;id&#39;);
    // 发起ajax请求
    $.ajax({
      type: &#39;GET&#39;,
      url: &#39;/user/findUser&#39;,
      data: {
        id: userId
      },
      success: function (result) {
        if (result.code == 200) {
          let modifyStr = template(&#39;modify_templ&#39;, result.data);
          $(&#39;#modify-modal&#39;).html(modifyStr);
          $(&#39;#modify-modal&#39;).modal(&#39;show&#39;);
        }
      }
    })
  })
  // 2)修改信息
  $(&#39;#modify-modal&#39;).on(&#39;click&#39;, &#39;.save-btn&#39;, function () {
    let formdata = $(&#39;#modify-form&#39;).serialize() + &#39;&amp;id=&#39; + $(this).data(&#39;id&#39;);
    // let formdata = new FormData(document.querySelector(&#39;#modify-form&#39;));
    // formdata.append(&#39;id&#39;, $(this).data(&#39;id&#39;))\

    // 请求方式一共12 常用4种(增(post)删(delete)改(put)查(get))  最常用2种
    $.ajax({
      type: &#39;PUT&#39;,
      url: &#39;/user/updateUser&#39;,
      data: formdata,
      success: function (result) {
        // console.log(result);
        if (result.code == 200) {
          $(&#39;#modify-modal&#39;).modal(&#39;hide&#39;);
          let pagenum = $(&#39;html&#39;).data(&#39;page&#39;);
          getUsers(pagenum);
        }
      }
    })
  })</code></pre>
<h4 id="userrouterjs-1">userRouter.js</h4>
<pre><code class="language-js">// 3.6 更新用户信息
userRouter.get(&#39;/findUser&#39;, findUser)
userRouter.put(&#39;/updateUser&#39;, updateUser)</code></pre>
<h4 id="userctrljs-1">userCtrl.js</h4>
<pre><code class="language-js">// 修改用户信息
module.exports.findUser = async (req, res) =&gt; {
  let { id } = req.query;
  let result = await User.findOne({ _id: id });
  // console.log(result);
  res.status(200).send({
    code: 200,
    msg: &quot;用户查询成功&quot;,
    data: result
  })
}
module.exports.updateUser = async (req, res) =&gt; {

  let { id, username, password, email, role, status } = req.body;
  // console.log(id, username, password, email, role, status);
  // 如果密码没有修改 就不能进行加密
  // 当用户修改信息的时候要进行前端校验 还要进行后端校验
  let result = await User.findOneAndUpdate({ _id: id }, {
    username: username,
    password: password &lt; 32 ? md5(md5(md5(req.body.password))) : password,
    email: email,
    role: role,
    status: status
  })

  // console.log(result);
  if (result._id) {
    res.status(200).send({
      code: 200,
      msg: &quot;用户信息更新成功&quot;,
      data: result
    })
  }

}</code></pre>
<h2 id="文章功能">文章功能</h2>
<h3 id="文章列表">文章列表</h3>
<h4 id="articlehtml">article.html</h4>
<pre><code class="language-html">&lt;!-- 插槽 --&gt;
{{block &#39;script&#39;}}
&lt;!-- 文章列表模板 --&gt;
&lt;script type=&quot;text/template&quot; id=&quot;table_templ&quot;&gt;
    {&amp; each records &amp;}
    &lt;tr&gt;
            &lt;td&gt;{&amp; $value._id &amp;}&lt;/td&gt;
            &lt;td&gt;{&amp; $value.title &amp;}&lt;/td&gt;
            &lt;td&gt;{&amp; $value.publishDate &amp;}&lt;/td&gt;
            &lt;td&gt;{&amp; $value.author.username &amp;}&lt;/td&gt;
            &lt;td&gt;

                    &lt;a href=&quot;javascript:;&quot; class=&quot;glyphicon glyphicon-edit&quot; data-id=&quot;{&amp; $value._id &amp;}&quot;&gt;&lt;/a&gt;

                    &lt;i class=&quot;glyphicon glyphicon-remove&quot;  data-id=&quot;{&amp; $value._id &amp;}&quot;&gt;&lt;/i&gt;
            &lt;/td&gt;
    &lt;/tr&gt;
    {&amp; /each &amp;}
&lt;/script&gt;
&lt;!-- 分页模板 --&gt;
&lt;script type=&quot;text/template&quot; id=&quot;pagination_templ&quot;&gt;

    &lt;li class=&quot;{&amp; page&lt;=1?&#39;disabled&#39;:&#39;&#39; &amp;}&quot; data-pagenum=&quot;{&amp; page-1 &amp;}&quot;&gt;&lt;a href=&quot;javascript:;&quot; &gt;&lt;span&gt;&amp;laquo;&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;

    {&amp; each display &amp;}
    &lt;li data-pagenum=&quot;{&amp; $value &amp;}&quot;&gt;&lt;a href=&quot;javascript:;&quot; &gt;{&amp; $value &amp;}&lt;/a&gt;&lt;/li&gt;
    {&amp; /each &amp;}
    &lt;li  class=&quot;{&amp; page&gt;=pages?&#39;disabled&#39;:&#39;&#39; &amp;}&quot; data-pagenum=&quot;{&amp; page+1 &amp;}&quot;&gt;&lt;a href=&quot;javascript:;&quot;&gt;&lt;span&gt;&amp;raquo;&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/script&gt;
&lt;script src=&quot;/lib/moment/moment-2.24.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/js/article.js&quot;&gt;&lt;/script&gt;
{{/block}}</code></pre>
<h4 id="articlejs">article.js</h4>
<pre><code class="language-js">$(function () {
  // 获取用户第一页数据
  getArticles();
  // 点击按钮,进行分页获取数据
  $(&#39;.pagination&#39;).on(&#39;click&#39;, &#39;li&#39;, function () {
    // 判断上一页 和下一页是否被禁用 如果被禁用 不能点击
    if ($(this).hasClass(&#39;disabled&#39;)) {
      return false;
    }
    // 获取按钮上的页码
    let pagenum = $(this).data(&#39;pagenum&#39;);
    // console.log(pagenum);
    // 把页码传给服务器
    getArticles(pagenum);

  })
})

/**
 * 分页获取用户列表
 * @param {*} pagenum 
 * @param {*} pagesize 
 */
function getArticles(pagenum, pagesize) {
  $.ajax({
    type: &#39;GET&#39;,
    url: &#39;/article/findArticles&#39;,
    data: {
      pageNum: pagenum || 1,
      pageSize: pagesize || 5
    },
    success: function (result) {
      console.log(result);
      for (let i = 0; i &lt; result.data.records.length; i++) {
        result.data.records[i].publishDate = moment(result.data.records[i].publishDate).format(&#39;YYYY-MM-DD&#39;)
      }
      let tableStr = template(&#39;table_templ&#39;, result.data);
      $(&#39;tbody&#39;).html(tableStr);
      $(&#39;html&#39;).attr(&#39;data-page&#39;, result.data.page);
      // // 渲染分页按钮
      let pageStr = template(&#39;pagination_templ&#39;, result.data);

      $(&#39;.pagination&#39;).html(pageStr);
    }
  })
}</code></pre>
<h4 id="articlerouterjs">articleRouter.js</h4>
<pre><code class="language-js">// 1.引入express
const express = require(&#39;express&#39;);
// 2.使用express的方法来创建路由
const { showArticle, findArticles, showAddArticle } = require(&#39;../controller/articleCtrl&#39;)
const articleRouter = express.Router();
// 3.创建路由
// 3.1 显示文章列表页
articleRouter.get(&#39;/&#39;, showArticle)
// 3.2 获取所有文章
articleRouter.get(&#39;/findArticles&#39;, findArticles)
// 显示文章添加页面
articleRouter.get(&#39;/edit&#39;, showAddArticle)
// 4.导出
module.exports = articleRouter;</code></pre>
<h4 id="articlectrljs">articleCtrl.js</h4>
<pre><code class="language-js">// 引入mongoose-sex-page
const mongooseSexPage = require(&#39;mongoose-sex-page&#39;);
// 引入文章集合
const Article = require(&#39;../model/dbArticle&#39;);
// 显示文章列表页
module.exports.showArticle = (req, res) =&gt; {
  if (!req.session.username) {
    // 如果用户强行进入 /user这个路由 如果没有用户名 我们应该让页面跳转到登录页面让用户登录
    res.redirect(&#39;/&#39;)
  } else {
    res.render(&#39;article&#39;);
  }

}

// 查找所有文章
module.exports.findArticles = async (req, res) =&gt; {
  // 通过解构赋值获取页码和每页显示多少条数据
  let { pageNum, pageSize } = req.query;
  // 通过分页插件 查询 文章
  let result = await mongooseSexPage(Article)
    .page(parseInt(pageNum))
    .size(parseInt(pageSize))
    .display(5)
    .find()
    .populate(&#39;author&#39;)
    .exec();

  // 给前端返回数据
  res.status(200).send({
    code: 200,
    msg: &quot;数据获取成功&quot;,
    data: result
  })
}

// 显示文章添加页面
module.exports.showAddArticle = (req, res) =&gt; {
  if (!req.session.username) {
    // 如果用户强行进入 /user这个路由 如果没有用户名 我们应该让页面跳转到登录页面让用户登录
    res.redirect(&#39;/&#39;)
  } else {
    res.render(&#39;article-edit&#39;);
  }

}</code></pre>
<h3 id="文章删除">文章删除</h3>
<h4 id="articlejs-1">article.js</h4>
<pre><code class="language-js">  // 点击删除按钮 删除文章
  $(&#39;tbody&#39;).on(&#39;click&#39;, &#39;i&#39;, function () {
    // console.log($(this).data(&#39;id&#39;));
    let id = $(this).data(&#39;id&#39;);
    $.ajax({
      type: &#39;delete&#39;,
      url: &#39;/article/deleteArticle&#39;,
      data: {
        id: id
      },
      // 在ajax发送数据之前 调用 只要return false 代码就停止执行
      beforeSend: function () {
        // 如果 return false 以后的这个代码都不会执行
        if (!confirm(&quot;您真的要删除该文章吗?&quot;)) {
          return false
        }
        // 如果是非return false 那么后面的代码就执行
      },
      // 当ajax请求成功之后 刷新页码
      success: function (result) {
        // console.log(result);
        if (result.code == 200) {
          let pagenum = $(&#39;html&#39;).data(&#39;page&#39;);
          getArticles(pagenum);
        }
      },
      // 当ajax完成之后 无论成功还是失败都执行
      // complete: function () {
      //   let pagenum = $(&#39;html&#39;).data(&#39;page&#39;);
      //   getArticles(pagenum);
      // }
    })
  })</code></pre>
<h4 id="articlerouterjs-1">articleRouter.js</h4>
<pre><code class="language-js">// 3.3 删除文章
articleRouter.delete(&#39;/deleteArticle&#39;, deleteArticle);</code></pre>
<h4 id="artriclectrljs">artricleCtrl.js</h4>
<pre><code class="language-js">module.exports.deleteArticle = async (req, res) =&gt; {
  let { id } = req.body;
  // console.log(id);
  let result = await Article.findOneAndDelete({ _id: id });
  // console.log(result);

  if (result._id) {
    res.status(200).send({
      code: 200,
      msg: &quot;文章删除成功&quot;,
      data: result
    })
  }
}
</code></pre>
<h3 id="文章添加">文章添加</h3>
<h4 id="思路-6">思路:</h4>
<p>1.处理封面图片上传(预览)
0.formdata添加数据
0.1 ajax把数据上传到服务器
1.1 当type为file的input 内容发生变化的时候，上传图片
1.2 使用multer来把文件上传到指定文件夹 public/upload
1.2.1 下载multer 引入multer
1.2.2 设置multer的选项
1.2.4 当文件上传完毕，获取上传完之后的图片路径，把图片路径存储在数据库
2.前端校验
3.后端校验
4.把数据存储到服务器
5.新文章发表成功 跳转文章首页</p>
<h3 id="文章更新">文章更新</h3>
